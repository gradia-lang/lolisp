<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Lolisp</title>
        <script
            src="https://gradia-lang.github.io/gradia.js"
            type="module"
        ></script>
    </head>

    <body>
        <div id="title">
            <h1>Lolisp</h1>
            <button onclick="run_lolisp()">▶️</button>
        </div>
        
        <div id="editor" contenteditable="true">
            <div class="expr">
                <div class="function">define</div>
                <div class="list">
                    <div class="symbol">inc</div>
                    <div class="symbol">n</div>
                    <span>&ThinSpace;</span>
                </div>
                <div class="list">
                    <div class="function">+</div>
                    <div class="symbol">n</div>
                    <div class="atom">1</div>
                    <span>　</span>
                </div>
                <span>&ThinSpace;</span>
            </div>
            <div class="expr">
                <div class="function">inc</div>
                <div class="atom">5</div>
                <span>&ThinSpace;</span>
            </div>
            <span>&ThinSpace;</span>
        </div>
        <br>

        <span style="font-size: 100px">↪︎</span>
        <pre id="result"> </pre>
    </body>

    <script>
        var pallet;

        function run_lolisp() {
            let gradia = new Gradia();
            let editor = document.getElementById("editor");
            let source = editor.children;

            for (let line of source) {
                code = compile(line);
                if (code === null) {
                    continue
                }

                console.log(code);
                let result = gradia.eval(code);
                if (result.trim() != "") {
                    document.getElementById("result").innerHTML = result;
                }
            }
        }

        function compile(source) {
            let inner = source.innerText;
            let trimed = inner.trim();
            if (source.className == "expr" || source.className == "list") {
                let list = [];
                let children = source.children;
                for (let item of children) {
                    let output = compile(item);
                    if (output !== null) {
                        list.push(output);
                    }    
                }
                return `${ (source.className == "list") ? "'" : "" }(${list.join(" ")})`
            } else if (source.className == "symbol") {
                return trimed;
            } else if (source.className == "function") {
                return `${trimed}:function`;
            } else if (source.className == "atom") {
                if (trimed == "true" || trimed == "false") {
                    return `${trimed}:bool`;
                } else if (!isNaN(parseFloat(trimed))) {
                    return `${trimed}:number`;
                } else {
                    return `"${trimed}":string`;
                }
                return inner.trim();
            } else {
                return null;
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById("editor").focus();
        })
    </script>

    <style>
        #result, button, .list, .symbol, .atom, .expr, .function, h1, #title, #editor, #pallet  {
            display: inline-block;
            border-radius: 10px;
            padding: 10px;
            margin: 2px;
        }

        #title {
            width: 97vw;
            align-items: center;
            background-color: lightblue;
        }
        #title h1 {
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            height: 50px;
        }



        span, #title h1  {
            color: darkslategrey;
        }

        #title button {
            background-color: transparent;
            padding: 0;
            margin-right: 1vh;
            border-style: none;
            font-size: 30px;
            cursor: pointer;
        }

        body {
            font-family: monospace;
            font-size: large;
            margin: 2vh;
            user-select: none;
        }

        #editor {
            margin-top: 20px;
            margin-bottom: 10px;
            padding: 30px;
            cursor: text;
        }

        #result {
            padding-left: 50px;
            padding-right: 50px;
            padding-top: 30px;
            padding-bottom: 30px;

            background-color: lightgray;
            border: 1px solid black;
        }

        .expr {
            background-color: aliceblue;
            border: 1px solid blue;
        }

        .list {
            background-color: rgb(195, 239, 195);
            border: 1px solid green;
        }

        .atom {
            background-color:lemonchiffon;
            border: 1px solid rgb(202, 202, 7);
        }

        .symbol {
            background-color:whitesmoke;
            border: 1px solid black;
        }

        .function {
            background-color: rgb(247, 213, 247);
            border: 1px solid purple;
        }
    </style>
</html>
